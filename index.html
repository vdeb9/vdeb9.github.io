<!DOCTYPE html>
<meta charset="utf-8">


<script src="https://d3js.org/d3.v7.js"></script>
<script src="https://unpkg.com/tone"></script><!--https://cdn.jsdelivr.net/npm/tone-->
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">






<p><span style="font-weight: bold; color:white; padding-left: 15px">Aleatorica</span>
<button style="color:white" class="w3-bar-item w3-button" onclick="openPage('Home', this)"> Info </button>
<!--<button class="w3-bar-item w3-button" onclick="openPage('Songs', this)">  Songs </button>-->
<button style="color:white" class="w3-bar-item w3-button" onclick="openPage('News', this)" id="defaultOpen"> Map </button>
<button style="color:white" class="w3-bar-item w3-button" onclick="openPage('Data', this)"> Data </button>
<button style="color:white" class="w3-bar-item w3-button" onclick="openPage('Ack', this)"> Load Page Without Sound</button></p>
<!--
<p><span style="color:red">Work in Progress!!!!</span>
-->

</div>
<style>body {background-color: black;}

#News { position: relative; } 


.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 2;
}

.spinner {
  width: 48px;
  height: 48px;
  border: 4px solid #fff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
</style>

<div id="Home" class="tabcontent">
  <p style="margin-left: 25px;width: 50%; color:white; ">Aleatorica is a mosaic-like music map that visualizes and sonifies the interval content of a large dataset of music by aleatorically regenerating its melody, creating a sonic landscape for exploring the continuum of melodic features in contemporary music. The piece blurs the lines between music data visualization and algorithmic compositional interface, giving a guided sonic tour through melody space.</p>
  <p style="margin-left: 25px;width: 50%; color:white; ">This project was presented at ISMIR 2024 as a Late Breaking Demo and ISMIR 2025 as a music performance.</p>
  <p style="margin-left: 25px;width: 50%; color:white; ">(Inspired in part by <a href="https://everynoise.com/">Every Noise at Once</a>!)</p>
</div>


<div id="Ack" class="tabcontent">
  
</div>

<div id="News" class="tabcontent">
  <div class="w3-container w3-border w3-large">
    <div id="loading-overlay" class="loading-overlay w3-display-container" style="display:none">
      <div class="w3-display-middle w3-center">
        <div class="w3-display-middle w3-center">
          <div class="spinner" aria-hidden="true"></div>
        </div>
        <div style="color:white; margin-top:12px;"><br><br><br>Loading 23,059 songsâ€¦</div>
      </div>
    </div>
  </div>
  <p><button class="w3-bar-item w3-button" style="color:white; position:fixed; background-color: transparent;" onclick="enableLoop()"> Turn on sound </button>
   <!--Speed <input type="range" name="mySlider" id=mySlider min="65" max="500" value="180">--></p>
  
  <script>
  
  var markovMat=[[1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  [1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],
  ]
  var notes = ["C3","Db3","D3","Eb3","E3","F3","Gb3","G3","Ab3","A3","Bb3","B3"]
  var notesExtra = ["C4","Db4","D4","Eb4","E4","F4","Gb4","G4","Ab4","A4","Bb4","B4"]
  var notesExtraExtra = ["C5","Db5","D5","Eb5","E5","F5","Gb5","G5","Ab5","A5","Bb5","B5"]
  
  var notestate=0;
  var stuckcounter=0;
  var harmonyArray = [0,0,0,0,0,0,0,0,0,0,0,0];


  const phaser = new Tone.Phaser().toDestination();
  const reverb = new Tone.Reverb().toDestination();

  const harmonyBus = new Tone.Gain().toDestination();
  const sharedReverb = new Tone.Reverb({ decay: 4, wet: 0.8 }).connect(harmonyBus);
  const lowCut = new Tone.Filter(300, "highpass");

  const sharedPhaster = new Tone.Phaser({ frequency: 0.5, octaves: 1, baseFrequency: 400 }).connect(lowCut).connect(sharedReverb);

  const hm = 1
  const mi = 5
  const Csynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)
  const Dbsynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)
  const Dsynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)
  const Ebsynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)
  const Esynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)
  const Fsynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm}).connect(sharedPhaster)
  const Gbsynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)
  const Gsynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm}).connect(sharedPhaster)
  const Absynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity:hm}).connect(sharedPhaster)
  const Asynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)
  const Bbsynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)
  const Bsynth = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)
  Csynth.volume.value = -80;
  Dbsynth.volume.value = -80;
  Dsynth.volume.value = -80;
  Ebsynth.volume.value = -80;
  Esynth.volume.value = -80;
  Fsynth.volume.value = -80;
  Gbsynth.volume.value = -80;
  Gsynth.volume.value = -80;
  Absynth.volume.value = -80;
  Asynth.volume.value = -80;
  Bbsynth.volume.value = -80;
  Bsynth.volume.value = -80;
  


  var rate=240 //180
  const effectPrime = new Tone.FeedbackDelay(0.375,0.6).toDestination();
  

  const droneBus    = new Tone.Gain(0.7).connect(sharedReverb);                 
  const droneDist   = new Tone.Distortion(0.00);
  const drone = new Tone.FMSynth({ modulationIndex: mi,harmonicity: hm }).connect(sharedPhaster)

  drone.volume.value = -22;
  function startDrone(root = "C2"){ drone.triggerAttack(root); }
  function stopDrone(){ drone.triggerRelease(); }



  const primeSynth = new Tone.MonoSynth({
    oscillator: { type: "square" },              
    filter:     { type: "lowpass", Q: 8, rolloff: -12 },
    envelope:   { attack: 0.001, decay: 0.08, sustain: 0.08, release: 0.08 },
    filterEnvelope: {
      attack: 0.001, decay: 0.05, sustain: 0.1, release: 0.05,
      baseFrequency: 500, octaves: 3.1,
    },
    portamento: 0
  }).connect(effectPrime);
  const primeSynth2 = new Tone.MonoSynth({
    oscillator: { type: "square" },               
    filter:     { type: "lowpass", Q: 4, rolloff: -24 },
    portamento: 0
  }).connect(effectPrime);
  primeSynth.volume.value = -50;
  primeSynth2.volume.value = -50;

  


  t=0
  var loop_on = 0;

  function showLoading() {
    const el = document.getElementById('loading-overlay');
    if (el) el.style.display = 'block';
  }
  function hideLoading() {
    const el = document.getElementById('loading-overlay');
    if (el) el.style.display = 'none';
  }

  function enableLoop() {
    if(loop_on==0) {
      loop_on=1
      notestate=0
      Tone.start();
      startDrone("C2");  
      Tone.Transport.start();
      playNote()
      
    } else {
      Tone.Transport.stop();
      stopDrone();  
      loop_on=0;
    }
    
  }
  function changeMarkov(d) {
    var denominator = [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]
    
    for(let i = 0; i < 144; i++) {
      denominator[parseInt((i-(i%12))/12)]+=parseFloat(d[i])
    }
    for(let i = 0; i < 144; i++) {
      if(denominator[parseInt((i-(i%12))/12)]!=0) {
        
        markovMat[i%12][parseInt((i-(i%12))/12)]=parseFloat(d[i])/denominator[parseInt((i-(i%12))/12)]
        
      } else {
        markovMat[i%12][parseInt((i-(i%12))/12)]=0
      }
      
    }
    //console.log(-Math.exp(-10*x+3.5)-17)
    const now = Tone.now();
    const thresh = 4.0;
    const maxvol = -16;
    Csynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[0]+thresh)+maxvol, now + 0.2);
    Dbsynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[1]+thresh)+maxvol, now + 0.2);
    Dsynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[2]+thresh)+maxvol, now + 0.2);
    Ebsynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[3]+thresh)+maxvol, now + 0.2);
    Esynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[4]+thresh)+maxvol, now + 0.2);
    Fsynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[5]+thresh)+maxvol, now + 0.2);
    Gbsynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[6]+thresh)+maxvol, now + 0.2);
    Gsynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[7]+thresh)+maxvol, now + 0.2);
    Absynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[8]+thresh)+maxvol, now + 0.2);
    Asynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[9]+thresh)+maxvol, now + 0.2);
    Bbsynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[10]+thresh)+maxvol, now + 0.2);
    Bsynth.volume.linearRampToValueAtTime(-Math.exp(-10*denominator[11]+thresh)+maxvol, now + 0.2);
    
    primeSynth.volume.value = -30;
    primeSynth2.volume.value = -27;
  }
  function playNote() {
    notetime=0.5
    //primeSynth.triggerAttackRelease("C2", notetime);
    primeSynth.triggerAttackRelease(notes[notestate], notetime);
    primeSynth2.triggerAttackRelease(notesExtraExtra[notestate], notetime);
    
    
    Csynth.triggerAttackRelease("C4",notetime);
    Dbsynth.triggerAttackRelease("Db4",notetime);
    Dsynth.triggerAttackRelease("D4",notetime);
    Ebsynth.triggerAttackRelease("Eb4",notetime);
    Esynth.triggerAttackRelease("E4",notetime);
    Fsynth.triggerAttackRelease("F4",notetime);
    Gbsynth.triggerAttackRelease("Gb4",notetime);
    Gsynth.triggerAttackRelease("G4",notetime);
    Absynth.triggerAttackRelease("Ab4",notetime);
    Asynth.triggerAttackRelease("A4",notetime);
    Bbsynth.triggerAttackRelease("Bb4",notetime);
    Bsynth.triggerAttackRelease("B4",notetime);
    
    


    var rand = Math.random()
    var count = 0
    for(let i = 0; i < 12; i++) {
      count+=parseFloat(markovMat[i][notestate])

      if(count>rand) {
        
        if(notestate==i){
          stuckcounter+=1;
        }
        
        notestate=i
        if(stuckcounter>2) {
          
          notestate=(i+7)%12
          stuckcounter=0
        }
        i=12
      }
    }
    setTimeout(function(){
      if(loop_on==1) {
        playNote()
      }
      
    }, rate);   
  }
  </script>

  <div id="my_dataviz">

      <!--<svg id="tooltip-svg" width="1" height="1" style="border:1px solid #ccc; margin-left: 20px;"></svg>
  -->
  </div>
</div>

<div id="Data" class="tabcontent">

</div>



<script>
  
  var data_array = new Array();
  var newsGraphRendered = false; 
  /*
  d3.select("#mySlider").on("change", function(d){

    rate = this.value
    //var svg = d3.select("#News");
    //svg.selectAll("circle").remove()

  })
  */
  function removeGraph() {
    var svg = d3.select("#News");
    svg.selectAll("*").html("");
  }
  function updateGraph() {
    var margin = {top: 0, right: 0, bottom: 0, left: 0},
        width = 900*2 - margin.left - margin.right,
        height = 600*2 - margin.top - margin.bottom;
    var svg = d3.select("#News");
    
  }

  function rgbToHex(r, g, b) {
  return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1);
  }
  function openPage(pageName, elmnt, color) {
    var i, tabcontent, tablinks;


    tabcontent = document.getElementsByClassName('tabcontent');
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = 'none'
    }

    tablinks = document.getElementsByClassName('tablink');
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].style.backgroundColor = '';
    }
    
    document.getElementById(pageName).style.display = 'block';
    elmnt.style.backgroundColor = color;
    
    if (pageName === 'News' && !newsGraphRendered) {
      showLoading(); 
      renderGraph(2023);
      newsGraphRendered = true;
    } 
    if (pageName === 'Data') {
      hideLoading();
      window.location.href = "https://figshare.com/articles/dataset/EveryIntervalMIDIDATA/25322941";
    } 
    console.log(pageName);
    if (pageName === 'Ack') {
      hideLoading();
      window.location.href = "nosound.html";
    } 

  }
  function showTooltipPolygon(data, pathD) {
    console.log('here')

  }

  function polyToPath(polygon) {

    maxx=0
    maxy=0
    minx=1800
    miny=1200
    for (let vert of polygon) {
      if (vert[0]<minx) {
        minx=vert[0]
      }
      if (vert[1]<miny) {
        miny=vert[1]
      }
      if (vert[0]>maxx) {
        maxx=vert[0]
      }
      if (vert[1]>maxy) {
        maxy=vert[1]
      }
    }
    if (maxx-minx>15) {return null}
    if (maxy-miny>15) {return null}
    return polygon ? "M" + polygon.join("L") + "Z" : null;
  }
  

  function renderGraph(selectedYear) {
    var margin = {top: 0, right: 0, bottom: 0, left: 0},
        width  = 900*2 - margin.left - margin.right,
        height = 600*2 - margin.top  - margin.bottom;

    var outerSvg = d3.select("#News")
      .append("g")
      .append("svg")
        .attr("width",  width  + margin.left + margin.right)
        .attr("height", height + margin.top  + margin.bottom);

    var g = outerSvg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    outerSvg.call(d3.zoom().on("zoom", function (event) {
      g.attr("transform", event.transform);
    }));

    g.append("rect").attr("width","100%").attr("height","100%").attr("fill","black");

    var tooltip = d3.select("#my_dataviz").append("div")
      .style("opacity", 0).attr("class","tooltip")
      .style("background-color","white").style("border","solid 1px")
      .style("border-radius","5px").style("padding","10px")
      .style("position","fixed").style("bottom","10px").style("left","10px");

    function onMouseOver(ev, d){ tooltip.style("opacity",1); changeMarkov(d.data); }
    function onMouseMove(ev, d){
      const r = d.data;
      tooltip.html(`${r.Title} - ${r.Artist}, ${r.Genre} (${r.x}, ${r.y})`);
    }
    function onMouseLeave(ev, d){ }

    d3.csv("https://raw.githubusercontent.com/buildercatninja/EveryIntervalcsv/main/EIAO_UMAP.csv")
      .then(function(data){
        const x = d3.scaleLinear().domain([-3.5-0, 13.5+0]).range([0, width]);
        const y = d3.scaleLinear().domain([-1-0, 11+0]).range([height, 0]);

        const pts = data.map(d => [ x(+d.x), y(+d.y) ]);
        const delaunay = d3.Delaunay.from(pts);
        const voronoi  = delaunay.voronoi([0, 0, width, height]);

        const MAX_CELL_AREA = 1000;  
        const MAX_SPAN      = 80;    

        function polygonArea(poly){
          let a = 0;
          for (let i=0, j=poly.length-1; i<poly.length; j=i++) {
            a += (poly[j][0]*poly[i][1] - poly[i][0]*poly[j][1]);
          }
          return Math.abs(a) * 0.5;
        }
        function polygonSpanOK(poly){
          let minx=Infinity, miny=Infinity, maxx=-Infinity, maxy=-Infinity;
          for (const [px,py] of poly){
            if (px<minx) minx=px; if (py<miny) miny=py;
            if (px>maxx) maxx=px; if (py>maxy) maxy=py;
          }
          return (maxx-minx) <= MAX_SPAN && (maxy-miny) <= MAX_SPAN;
        }

        const cells = [];
        for (let i=0; i<data.length; i++){
          const poly = voronoi.cellPolygon(i);  
          if (!poly) continue;
          if (!polygonSpanOK(poly)) continue;
          if (polygonArea(poly) > MAX_CELL_AREA) continue;
          cells.push({
            path: voronoi.renderCell(i),  
            data: data[i]
          });
        }

        g.append("g")
          .selectAll("path")
          .data(cells)
          .enter()
          .append("path")
            .attr("d", d => d.path)
            .attr("fill", d => d3.rgb(
              Math.round(+d.data.r * 255),
              Math.round(+d.data.g * 255),
              Math.round(+d.data.b * 255)
            ))
            .attr("pointer-events", "all")
            .on("mouseover", onMouseOver)
            .on("mousemove", onMouseMove)
            .on("mouseleave", onMouseLeave)
            .on("click", (event, d) => showTooltipPolygon(d.data, d.path));

        g.append("path")
          .attr("d", voronoi.render())
          .attr("fill", "none")
          .attr("stroke", "rgba(255,255,255,0.28)")
          .attr("stroke-width", 0.5)
          .attr("vector-effect", "non-scaling-stroke")
          .attr("shape-rendering", "crispEdges")
          .attr("pointer-events", "none");

        hideLoading();
      })
      .catch(err => { console.error(err); hideLoading(); });
  }

  
  document.getElementById("defaultOpen").click();
</script>






</html>
